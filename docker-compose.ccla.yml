version: "3.8"

services:
  cloudclapp:
    depends_on:
      - msa-api
    container_name: ccla_ui
    image: ubiqube/cloudclapp:9f89e07a3e831764949b371ae028fc33532795ef
    environment:
      - UBIQUBE_CAPTCHA_SITE_KEY=6Ld2zF4dAAAAAJlqZMIHpPeb3aYhcyy1K3NWPtqi
      - UBIQUBE_LICENSE_AGREEMENT_LINK=https:\/\/cloudclapp.com\/EndUserLicenceAgreement.html
    healthcheck:
      test: ["CMD-SHELL", "curl --fail http://localhost:8080"]

  ccla-scan-app:
    container_name: ccla_scan_app
    image: ubiqube/cloudclapp-scan:2b4a509e0f85df70d4b8ba738b0c1a11f44a8da7
    environment:
      - UBIQUBE_ZAP_TOKEN=7da091fe-63a4-48c0-9bfa-7614c49feb7c

  ccla-scan-env:
    container_name: ccla_scan_env
    image: owasp/zap2docker-stable:2.11.1
    entrypoint:
      - zap.sh
      - -daemon
      - -host
      - 0.0.0.0
      - -config
      - api.addrs.addr.name=.*
      - -config
      - api.addrs.addr.regex=true
      - -config
      - api.key=7da091fe-63a4-48c0-9bfa-7614c49feb7c
      - -config
      - network.localServers.mainProxy.alpn.enabled=false
      - -config
      - network.localServers.mainProxy.address=0.0.0.0

  key-vault:
    restart: unless-stopped
    depends_on:
      db: 
        condition: service_healthy
    container_name: key_vault
    image: hashicorp/vault:latest
    ports:
      - "8200:8200"
    volumes:
      - ./lab/key_vault/config.hcl:/vault/config/config.hcl
    environment:
      VAULT_ADDR: "http://0.0.0.0:8200"
    cap_add:
      - IPC_LOCK
    command: server

  msa-sms:
    environment:
      - UBIQUBE_INSTALL_AWS_CLI=true

  msa-api:
    environment:
      - UBIQUBE_BYPASS_CAPTCHA=true
      
  msa-dev:
    command: [ "/docker-entrypoint.sh", "--cloudclapp" ]
